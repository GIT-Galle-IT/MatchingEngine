#include <benchmark/benchmark.h>
#include <ByteBuffer.hpp>
#include <demos/message.h>
#include <ObjectPool.hpp>
#include <sstream>

// #include "../matching/MatchingEngine.hpp"

static void BM_WithoutObjPooling(benchmark::State &state)
{
  Message message{8888, 1000, "Hello, Server request from clienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclientele", true, 10000000};
  GLOG_DEBUG_L1("Size of request: {}", sizeof(message));

  std::stringstream oss;
  message.serialize(oss);
  const char *some_string = oss.str().c_str();

  ByteBuffer<int> bb;

  for (auto _ : state)
  {
    bb.allocate_new(some_string, oss.str().size());
    bb.release_new();
  }
}

static void BM_WithObjPooling_singleton_pool(benchmark::State &state)
{
  Message message{8888, 1000, "Hello, Server request from clienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclientele", true, 10000000};
  GLOG_DEBUG_L1("Size of request: {}", sizeof(message));

  std::stringstream oss;
  message.serialize(oss);
  const char *some_string = oss.str().c_str();

  ByteBuffer<int> bb;

  for (auto _ : state)
  {
    bb.allocate_singleton_pool(some_string, oss.str().size());
    bb.release_singleton_pool();
  }
}

// static void BM_WithObjPooling_object_pool(benchmark::State &state)
// {
//   Message message{8888, 1000, "Hello, Server request from clienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclienteleclientele", true, 10000000};
//   GLOG_DEBUG_L1("Size of request: {}", sizeof(message));

//   std::stringstream oss;
//   message.serialize(oss);
//   const char *some_string = oss.str().c_str();

//   ByteBuffer<int> bb;

//   for (auto _ : state)
//   {
//     bb.allocate_object_pool(some_string, oss.str().size());
//     bb.release_object_pool();
//   }
// }


// Register the function as a benchmark
BENCHMARK(BM_WithoutObjPooling);
BENCHMARK(BM_WithObjPooling_singleton_pool);
// BENCHMARK(BM_WithObjPooling_object_pool);
BENCHMARK_MAIN();